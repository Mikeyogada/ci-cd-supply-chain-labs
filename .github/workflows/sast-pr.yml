---
name: SAST-PR Diff Aware

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  sast-pr:
    runs-on: ubuntu-latest
    continue-on-error: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed source files
        run: |
          git diff --name-only \
            ${{ github.event.pull_request.base.sha }} \
            ${{ github.event.pull_request.head.sha }} \
            | grep -E '\.(py|js|java)$' > changed.txt || true

          echo "Changed files:"
          cat changed.txt || echo "No relevant files changed."

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep on changed files
        run: |
          if [ -s changed.txt ]; then
            echo "Running Semgrep on changed files..."
            semgrep scan \
              --config auto \
              --sarif \
              --output semgrep.sarif \
              $(cat changed.txt)
          else
            echo "No relevant source code changes detected. Skipping SAST."
            exit 0
          fi

      - name: Upload SARIF results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
